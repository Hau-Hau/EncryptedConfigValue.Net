name: Update nuspec files

on:
  workflow_dispatch:
  pull_request:
    types: [closed]
    branches:
      - main

concurrency:
  group: update-nuspec
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      result-module: ${{ steps.validate.outputs.result-module }}
      result-aspnetcore: ${{ steps.validate.outputs.result-aspnetcore }}

    steps:
      - uses: ./.github/actions/has-changes-action
        id: has-changes-module
        with:
          project: EncryptedConfigValue.Module

      - uses: ./.github/actions/has-changes-action
        id: has-changes-aspnetcore
        with:
          project: EncryptedConfigValue.AspNetCore

      - name: Validate
        id: validate
        run: |
          echo "result-module=${{ steps.has-changes-module.outputs.result }}" >> $GITHUB_OUTPUT
          echo "result-aspnetcore=${{ steps.has-changes-aspnetcore.outputs.result }}" >> $GITHUB_OUTPUT

  module:
    needs: [validate]
    if: needs.validate.outputs.result-module == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: ./.github/actions/setup-dotnet-action
        with:
          project: EncryptedConfigValue.Module

  aspnetcore:
    needs: [validate]
    if: needs.validate.outputs.result-aspnetcore == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: ./.github/actions/setup-dotnet-action
        with:
          project: EncryptedConfigValue.AspNetCore
